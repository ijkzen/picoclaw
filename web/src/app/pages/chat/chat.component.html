<div class="mx-auto flex h-full min-h-0 w-full max-w-[960px] flex-col"
  style="display: flex; height: 100%; min-height: 0; width: 100%; max-width: 960px; margin: 0 auto; flex-direction: column;">
  <div #messagesContainer class="min-h-0 flex-1 overflow-y-auto px-3 pb-6 pt-5 sm:px-6"
    style="min-height: 0; flex: 1 1 auto; overflow-y: auto;">
    @if (messages().length === 0) {
    <section
      class="mx-auto mt-8 flex max-w-[720px] flex-col gap-6 rounded-3xl border border-[var(--mat-sys-outline-variant)] bg-[var(--mat-sys-surface-container-low)] p-6 sm:p-8">
      <header class="space-y-2">
        <p class="text-sm font-medium tracking-[0.08em] uppercase opacity-75">PicoClaw Assistant</p>
        <h1 class="text-2xl font-semibold leading-tight sm:text-3xl">Ask anything and iterate quickly</h1>
        <p class="text-sm opacity-80 sm:text-base">
          Use a quick prompt to start, or type your own request below.
        </p>
      </header>

      <div class="grid gap-2 sm:grid-cols-2">
        @for (prompt of quickPrompts; track prompt) {
        <button type="button" mat-stroked-button
          class="!h-auto !justify-start !rounded-2xl !border-[var(--mat-sys-outline-variant)] !px-4 !py-3 !text-left !text-sm !leading-5"
          (click)="sendQuickMessage(prompt)">
          {{ prompt }}
        </button>
        }
      </div>
    </section>
    } @else {
    <div class="mx-auto flex w-full max-w-[900px] flex-col gap-4 pb-2">
      @for (message of messages(); track message.id) {
      <article class="flex gap-3" [class.justify-end]="message.role === 'user'">
        <div class="flex max-w-[95%] gap-3 sm:max-w-[90%] min-w-[90%]"
          [class.flex-row-reverse]="message.role === 'user'">
          <div
            class="flex h-9 w-9 shrink-0 items-center justify-center rounded-full border border-[var(--mat-sys-outline-variant)] bg-[var(--mat-sys-surface-container)]">
            <mat-icon>
              {{ message.role === 'user' ? 'person' : 'smart_toy' }}
            </mat-icon>
          </div>

          <div class="w-full flex-1">

            <!-- Message content -->
            <div class="rounded-2xl border border-[var(--mat-sys-outline-variant)] p-3 shadow-sm"
              [class.bg-[var(--mat-sys-primary-container)]]="message.role === 'user'"
              [class.bg-[var(--mat-sys-surface-container-lowest)]]="message.role !== 'user'">

              @if (message.showRawContent) {
              <pre
                class="m-0 whitespace-pre-wrap break-words font-inherit text-sm leading-6">{{ message.content }}</pre>
              } @else {
              <div class="markdown-content text-sm leading-6" [innerHTML]="renderMarkdown(message.content)"></div>
              }

              <!-- Streaming indicator -->
              @if (!message.isComplete) {
              <mat-progress-bar mode="indeterminate" class="mt-2 "></mat-progress-bar>
              }
            </div>

            <!-- Action buttons -->
            <div class="mt-1 flex gap-2 justify-end">
              <button mat-button (click)="toggleRawContent(message)" class="text-xs">
                {{ message.showRawContent ? '显示 Markdown' : '显示原文' }}
              </button>
            </div>

            <!-- Timestamp -->
            <div class="mt-1 px-1 text-xs opacity-65" [class.text-right]="message.role === 'user'">
              {{ message.timestamp | date:'shortTime' }}
            </div>
          </div>
        </div>
      </article>
      }
    </div>
    }
  </div>

  <div
    class="w-full bottom-0 z-10 shrink-0 border-t border-[var(--mat-sys-outline-variant)] bg-[color-mix(in_srgb,var(--mat-sys-surface)_92%,transparent)] px-3 pb-[max(0.75rem,env(safe-area-inset-bottom))] pt-3 backdrop-blur sm:px-6">
    <div class="flex w-full items-center justify-center gap-3 mt-4">
      <mat-form-field appearance="outline" class="flex-1">
        <mat-label>Type your message...</mat-label>
        <textarea matInput [ngModel]="inputMessage()" (ngModelChange)="inputMessage.set($event)"
          (keydown)="onKeydown($event)" cdkTextareaAutosize cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5"></textarea>

        <button type="button" color="primary" matIconButton matSuffix [disabled]="!inputMessage().trim() || isLoading()"
          (click)="sendMessage()" aria-label="Send message" matTooltip="Send message (Enter)">
          @if (isLoading()) {
          <mat-spinner diameter="24"></mat-spinner>
          } @else {
          <mat-icon>send</mat-icon>
          }
        </button>
      </mat-form-field>
    </div>
  </div>
</div>